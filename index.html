<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tính Tải Lạnh Siêu Thị</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel để biên dịch JSX ngay trên trình duyệt -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ĐỊNH NGHĨA ICON TRỰC TIẾP (Fix lỗi thư viện Lucide) ---
        const Icon = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Calculator = (props) => <Icon {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></Icon>;
        const Thermometer = (props) => <Icon {...props}><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></Icon>;
        const Wind = (props) => <Icon {...props}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 1 14 16H2"/></Icon>;
        const Snowflake = (props) => <Icon {...props}><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/><path d="m20 16-4-4 4-4"/><path d="m4 8 4 4-4 4"/><path d="m16 4-4 4-4-4"/><path d="m8 20 4-4 4 4"/></Icon>;
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></Icon>;
        const Copy = (props) => <Icon {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></Icon>;
        const Check = (props) => <Icon {...props}><polyline points="20 6 9 17 4 12"/></Icon>;
        const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const List = (props) => <Icon {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></Icon>;
        // -------------------------------------------------------------

        const SupermarketLoadCalc = () => {
            const [area, setArea] = useState('');
            const [zoneType, setZoneType] = useState('sales_general');
            const [ceilingHeight, setCeilingHeight] = useState('standard');
            const [zoneName, setZoneName] = useState('');
            const [result, setResult] = useState(null);
            const [copied, setCopied] = useState(false);
            const [savedZones, setSavedZones] = useState([]);

            // Định mức nhiệt tải (BTU/m2)
            const loadFactors = {
                sales_general: { label: 'Khu vực bán hàng chung', value: 750, desc: 'Mật độ người vừa phải, ít thiết bị sinh nhiệt.' },
                sales_fresh: { label: 'Khu thực phẩm tươi sống', value: 650, desc: 'Có tủ đông hỗ trợ làm lạnh không khí.' },
                checkout: { label: 'Khu vực thu ngân/Cửa', value: 950, desc: 'Mật độ người cao, thất thoát nhiệt lớn.' },
                bakery: { label: 'Khu lò nướng/Bếp nóng', value: 1200, desc: 'Nhiệt tỏa ra từ lò nướng rất lớn.' },
                warehouse: { label: 'Kho chứa hàng', value: 550, desc: 'Ít người, chủ yếu bảo quản.' },
            };

            const heightFactors = {
                standard: { label: 'Tiêu chuẩn (< 3.5m)', multiplier: 1.0 },
                high: { label: 'Cao (3.5m - 5m)', multiplier: 1.15 },
                very_high: { label: 'Thông tầng (> 5m)', multiplier: 1.3 },
            };

            useEffect(() => {
                calculateLoad();
            }, [area, zoneType, ceilingHeight]);

            const calculateLoad = () => {
                const areaNum = parseFloat(area);
                if (!areaNum || areaNum <= 0) {
                    setResult(null);
                    return;
                }

                const baseLoadPerM2 = loadFactors[zoneType].value;
                const heightMultiplier = heightFactors[ceilingHeight].multiplier;

                const totalBtu = Math.round(areaNum * baseLoadPerM2 * heightMultiplier);
                const hp = (totalBtu / 9000).toFixed(1);
                const kw = (totalBtu / 3412).toFixed(1);
                const ton = (totalBtu / 12000).toFixed(1);

                setResult({ btu: totalBtu, hp: hp, kw: kw, ton: ton });
            };

            const handleAddZone = () => {
                if (!result || !area) return;

                const newZone = {
                    id: Date.now(),
                    name: zoneName || `Khu vực ${savedZones.length + 1}`,
                    area: parseFloat(area),
                    zoneTypeLabel: loadFactors[zoneType].label,
                    ceilingHeightLabel: heightFactors[ceilingHeight].label,
                    btu: result.btu,
                    hp: parseFloat(result.hp),
                    kw: parseFloat(result.kw)
                };

                setSavedZones([...savedZones, newZone]);
                setZoneName('');
                setArea('');
                setResult(null);
            };

            const handleDeleteZone = (id) => {
                setSavedZones(savedZones.filter(z => z.id !== id));
            };

            const handleReset = () => {
                setArea('');
                setZoneType('sales_general');
                setCeilingHeight('standard');
                setZoneName('');
                setResult(null);
            };

            const copyToClipboard = () => {
                let text = "";
                if (savedZones.length > 0) {
                    text = "BẢNG TÍNH TẢI LẠNH TỔNG HỢP\n---------------------------\n";
                    savedZones.forEach((z, i) => {
                        text += `${i + 1}. ${z.name} (${z.area}m2): ${z.btu.toLocaleString()} BTU | ${z.hp} HP\n`;
                    });
                    text += "---------------------------\n";
                    text += `TỔNG CỘNG: ${totalStats.btu.toLocaleString()} BTU | ${totalStats.hp.toFixed(1)} HP`;
                } else if (result) {
                    text = `TÍNH TẢI LẠNH: ${area}m2 - ${result.btu.toLocaleString()} BTU - ${result.hp} HP`;
                } else {
                    return;
                }

                // Copy logic
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    console.error('Lỗi copy', err);
                }
                document.body.removeChild(textArea);
            };

            const totalStats = savedZones.reduce((acc, curr) => ({
                area: acc.area + curr.area,
                btu: acc.btu + curr.btu,
                hp: acc.hp + curr.hp,
                kw: acc.kw + curr.kw
            }), { area: 0, btu: 0, hp: 0, kw: 0 });

            const getRecommendation = (hp) => {
                const hpNum = parseFloat(hp);
                if (hpNum < 2.5) return "Máy treo tường hoặc Cassette nhỏ";
                if (hpNum < 6) return "Cassette hoặc Giấu trần nối ống gió";
                if (hpNum < 20) return "Tủ đứng hoặc Giấu trần (Packaged)";
                return "Hệ thống trung tâm VRV/VRF hoặc Chiller";
            };

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800">
                    <div className="max-w-5xl mx-auto space-y-6">
                        
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-sm p-6 border-l-8 border-blue-600 flex items-center justify-between">
                            <div>
                                <h1 className="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-2">
                                    <Snowflake className="text-blue-500 w-8 h-8" />
                                    Tính Tải Lạnh Siêu Thị
                                </h1>
                                <p className="text-slate-500 mt-1">Công cụ ước tính công suất điều hòa & lập bảng tổng hợp</p>
                            </div>
                            <div className="hidden md:block">
                                <Calculator className="w-12 h-12 text-slate-200" />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                            
                            {/* Input Section */}
                            <div className="md:col-span-5 space-y-4">
                                <div className="bg-white rounded-xl shadow-sm p-6 border border-slate-200">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 text-slate-800">
                                        <Wind className="w-5 h-5 text-blue-600" />
                                        Thông số khu vực
                                    </h2>

                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-slate-700 mb-1">
                                            Tên khu vực (Tùy chọn)
                                        </label>
                                        <input
                                            type="text"
                                            value={zoneName}
                                            onChange={(e) => setZoneName(e.target.value)}
                                            placeholder="VD: Sảnh chính, Kho..."
                                            className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                        />
                                    </div>

                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-slate-700 mb-1">
                                            Diện tích mặt sàn (m²) <span className="text-red-500">*</span>
                                        </label>
                                        <div className="relative">
                                            <input
                                                type="number"
                                                min="1"
                                                value={area}
                                                onChange={(e) => setArea(e.target.value)}
                                                placeholder="Nhập diện tích..."
                                                className="w-full pl-4 pr-12 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-lg font-medium"
                                            />
                                            <span className="absolute right-4 top-3.5 text-slate-400 font-medium">m²</span>
                                        </div>
                                    </div>

                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-slate-700 mb-1">
                                            Loại không gian
                                        </label>
                                        <select
                                            value={zoneType}
                                            onChange={(e) => setZoneType(e.target.value)}
                                            className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                        >
                                            {Object.entries(loadFactors).map(([key, data]) => (
                                                <option key={key} value={key}>{data.label}</option>
                                            ))}
                                        </select>
                                        <p className="text-xs text-slate-500 mt-1 italic">
                                            * {loadFactors[zoneType].desc}
                                        </p>
                                    </div>

                                    <div className="mb-6">
                                        <label className="block text-sm font-medium text-slate-700 mb-1">
                                            Độ cao trần
                                        </label>
                                        <select
                                            value={ceilingHeight}
                                            onChange={(e) => setCeilingHeight(e.target.value)}
                                            className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                        >
                                            {Object.entries(heightFactors).map(([key, data]) => (
                                                <option key={key} value={key}>{data.label}</option>
                                            ))}
                                        </select>
                                    </div>

                                    <div className="flex gap-3">
                                        <button 
                                            onClick={handleReset}
                                            className="flex-1 py-2 px-4 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 transition flex items-center justify-center gap-2"
                                        >
                                            <RotateCcw className="w-4 h-4" />
                                            Đặt lại
                                        </button>
                                        <button 
                                            onClick={handleAddZone}
                                            disabled={!result}
                                            className={`flex-1 py-2 px-4 rounded-lg font-medium transition flex items-center justify-center gap-2 shadow-md ${
                                                result 
                                                ? 'bg-blue-600 text-white hover:bg-blue-700' 
                                                : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                                            }`}
                                        >
                                            <Plus className="w-5 h-5" />
                                            Thêm dòng
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Results Section */}
                            <div className="md:col-span-7">
                                {result ? (
                                    <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden h-full flex flex-col">
                                        <div className="bg-slate-800 p-4 text-white flex justify-between items-center">
                                            <span className="font-semibold">Kết quả tạm tính</span>
                                            <span className="text-xs bg-slate-700 px-2 py-1 rounded">Chưa lưu</span>
                                        </div>
                                        
                                        <div className="p-6 flex-1 flex flex-col justify-center">
                                            <div className="text-center mb-6">
                                                <p className="text-slate-500 uppercase text-xs font-bold tracking-wider mb-2">Công suất lạnh yêu cầu</p>
                                                <div className="flex justify-center items-baseline gap-2">
                                                    <span className="text-5xl font-bold text-blue-600">{result.btu.toLocaleString()}</span>
                                                    <span className="text-xl text-blue-400 font-medium">BTU/h</span>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-2 gap-4 mb-4">
                                                <div className="bg-orange-50 rounded-lg p-3 border border-orange-100 text-center">
                                                    <p className="text-2xl font-bold text-orange-600">{result.hp}</p>
                                                    <p className="text-orange-400 text-xs font-bold uppercase">HP (Ngựa)</p>
                                                </div>
                                                <div className="bg-emerald-50 rounded-lg p-3 border border-emerald-100 text-center">
                                                    <p className="text-2xl font-bold text-emerald-600">{result.kw}</p>
                                                    <p className="text-emerald-400 text-xs font-bold uppercase">kW Lạnh</p>
                                                </div>
                                            </div>

                                            <div className="bg-blue-50 rounded-lg p-3 border border-blue-100 text-sm text-center">
                                                <p className="text-slate-700">
                                                Bấm nút <strong className="text-blue-700">+ Thêm dòng</strong> để lưu kết quả này vào bảng tổng hợp bên dưới.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 h-full flex flex-col items-center justify-center p-8 text-center text-slate-400 min-h-[300px]">
                                        <div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                                            <Plus className="w-8 h-8 text-slate-300" />
                                        </div>
                                        <h3 className="text-lg font-medium text-slate-600">Nhập thông tin để tính toán</h3>
                                        <p className="max-w-xs mt-2 text-sm">Điền diện tích và loại khu vực, sau đó bấm "Thêm dòng" để xây dựng bảng tổng hợp.</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Saved Zones Table */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                    <List className="w-5 h-5 text-blue-600" />
                                    Bảng Tổng Hợp Công Suất
                                </h3>
                                {savedZones.length > 0 && (
                                    <button 
                                        onClick={copyToClipboard}
                                        className="flex items-center gap-1 text-xs bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-3 py-1.5 rounded-lg transition shadow-sm"
                                    >
                                        {copied ? <Check className="w-3 h-3 text-green-600" /> : <Copy className="w-3 h-3" />}
                                        {copied ? 'Đã chép' : 'Sao chép bảng'}
                                    </button>
                                )}
                            </div>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-500 font-medium uppercase text-xs">
                                        <tr>
                                            <th className="px-4 py-3">STT</th>
                                            <th className="px-4 py-3">Khu vực</th>
                                            <th className="px-4 py-3">Loại / Trần</th>
                                            <th className="px-4 py-3 text-right">Diện tích (m²)</th>
                                            <th className="px-4 py-3 text-right">BTU/h</th>
                                            <th className="px-4 py-3 text-right">HP</th>
                                            <th className="px-4 py-3 text-center">Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {savedZones.length === 0 ? (
                                            <tr>
                                                <td colSpan="7" className="px-4 py-8 text-center text-slate-400 italic">
                                                    Chưa có khu vực nào được thêm.
                                                </td>
                                            </tr>
                                        ) : (
                                            savedZones.map((zone, index) => (
                                                <tr key={zone.id} className="hover:bg-slate-50">
                                                    <td className="px-4 py-3 text-slate-400">{index + 1}</td>
                                                    <td className="px-4 py-3 font-medium text-slate-800">{zone.name}</td>
                                                    <td className="px-4 py-3 text-slate-500">
                                                        <div className="flex flex-col">
                                                            <span>{zone.zoneTypeLabel}</span>
                                                            <span className="text-xs text-slate-400">Trần: {zone.ceilingHeightLabel}</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-3 text-right font-medium">{zone.area}</td>
                                                    <td className="px-4 py-3 text-right text-blue-600 font-semibold">{zone.btu.toLocaleString()}</td>
                                                    <td className="px-4 py-3 text-right font-medium">{zone.hp}</td>
                                                    <td className="px-4 py-3 text-center">
                                                        <button 
                                                            onClick={() => handleDeleteZone(zone.id)}
                                                            className="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition"
                                                            title="Xóa dòng này"
                                                        >
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                    {savedZones.length > 0 && (
                                        <tfoot className="bg-blue-50 font-bold text-blue-900">
                                            <tr>
                                                <td colSpan="3" className="px-4 py-4 text-right uppercase text-xs tracking-wider">Tổng cộng</td>
                                                <td className="px-4 py-4 text-right">{totalStats.area} m²</td>
                                                <td className="px-4 py-4 text-right text-lg">{totalStats.btu.toLocaleString()}</td>
                                                <td className="px-4 py-4 text-right text-lg">{totalStats.hp.toFixed(1)} HP</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    )}
                                </table>
                            </div>
                        </div>

                        {/* Final Recommendation */}
                        {savedZones.length > 0 && (
                            <div className="bg-slate-800 text-white p-4 rounded-xl shadow-lg flex flex-col md:flex-row items-center justify-between gap-4">
                                <div>
                                    <h4 className="font-bold flex items-center gap-2">
                                        <Info className="w-5 h-5 text-yellow-400" />
                                        Kết luận hệ thống tổng:
                                    </h4>
                                    <p className="text-slate-300 text-sm mt-1">
                                        Tổng tải lạnh toàn công trình là <strong className="text-white">{totalStats.hp.toFixed(1)} HP</strong> (~{totalStats.kw.toFixed(1)} kW lạnh).
                                    </p>
                                </div>
                                <div className="bg-slate-700 py-2 px-4 rounded-lg text-sm font-medium border border-slate-600">
                                    {getRecommendation(totalStats.hp)}
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SupermarketLoadCalc />);
    </script>
</body>
</html>